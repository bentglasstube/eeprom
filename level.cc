#include "level.h"

Level::Push::Push(std::pair<int, int> from, std::pair<int, int> to) :
  from(from), to(to)
{}

int Level::Push::dx() const {
  return to.first - from.first;
}

int Level::Push::dy() const {
  return to.second - from.second;
}

Level::Level() : map_() {
  map_.set_size(12, 14);
}

void Level::load(int level) {
  pistons_.clear();
  crates_.clear();

  switch (level) {
    case 1:
      populate({
          84,98,98,99,13,97,98,98,98,98,98,85,
          91,3,1,1,33,1,1,1,3,3,3,89,
          91,3,3,1,33,1,1,1,1,1,1,89,
          91,3,3,1,33,1,1,1,1,1,1,97,
          91,1,1,9,33,17,17,17,17,17,17,17,
          91,1,1,1,33,1,1,1,1,1,1,81,
          91,1,1,1,33,1,1,2,2,1,1,89,
          91,1,1,1,33,1,1,2,2,1,1,89,
          91,1,1,1,33,1,1,1,1,1,1,89,
          91,1,1,1,33,1,1,81,82,82,82,93,
          91,86,87,87,87,87,88,89,90,90,90,90,
          91,94,95,95,95,95,96,89,90,90,90,90,
          91,102,103,103,103,103,104,89,90,90,90,90,
          92,82,82,82,82,82,82,93,90,90,90,90
          });

      start_ = { 4, 1, Map::Facing::S };
      pistons_.emplace_back(3, 4, Map::Facing::E, 4);

      break;

    case 2:
      populate({
          84,98,98,98,98,98,98,98,98,98,98,85,
          91,3,3,86,87,87,88,3,3,3,3,89,
          91,3,1,94,95,95,96,1,1,3,3,89,
          99,1,1,102,103,103,104,11,1,3,3,97,
          15,17,17,17,17,17,17,1,1,1,1,1,
          83,1,1,12,12,1,12,33,1,1,1,81,
          91,1,1,1,1,1,1,33,1,1,3,89,
          91,1,3,1,1,3,1,33,1,3,3,89,
          91,1,3,3,3,1,1,33,1,3,1,89,
          91,1,1,3,3,1,1,33,1,1,1,89,
          91,86,87,87,87,87,87,87,87,87,88,89,
          91,94,95,95,95,95,95,95,95,95,96,89,
          91,102,103,103,103,103,103,103,103,103,104,89,
          92,82,82,82,82,82,82,82,82,82,82,93
          });

      start_ = { 1, 4, Map::Facing::E };
      pistons_.emplace_back(3, 5, Map::Facing::N, 4, 4);
      pistons_.emplace_back(4, 5, Map::Facing::N, 4, 3);
      pistons_.emplace_back(6, 5, Map::Facing::N, 4, 2);
      pistons_.emplace_back(7, 3, Map::Facing::S, 4, 1);

      break;

    case 3:
      populate({
          84,98,98,98,98,98,98,99,13,97,98,85,
          91,1,1,3,1,3,1,1,1,1,1,89,
          91,1,3,3,3,1,1,1,1,3,1,89,
          99,1,1,1,1,1,1,2,1,3,1,89,
          15,18,18,18,1,1,1,1,3,1,3,89,
          83,1,1,1,1,2,1,1,3,3,1,89,
          91,1,1,1,1,1,1,1,3,1,1,89,
          91,1,1,1,1,1,34,1,1,1,1,89,
          91,3,3,3,1,1,34,1,1,1,1,89,
          91,3,3,3,1,1,34,1,1,1,1,89,
          91,3,1,1,1,1,34,1,1,1,1,89,
          91,3,1,3,3,1,34,1,1,1,3,89,
          91,3,3,3,3,1,34,1,1,1,1,89,
          92,82,82,82,82,83,1,81,82,82,82,93
          });

      start_ = { 1, 4, Map::Facing::E };

      break;

    case 4:
      populate({
          84,98,98,98,98,99,13,97,98,98,98,85,
          91,1,3,1,1,1,33,1,1,1,1,89,
          91,1,3,1,1,1,33,1,1,1,1,89,
          91,1,1,1,1,1,33,1,1,1,1,89,
          91,1,1,1,1,1,33,1,1,1,1,89,
          91,1,1,1,1,1,1,1,1,1,1,89,
          91,2,2,2,1,1,2,1,1,2,2,89,
          91,3,3,3,1,1,1,1,1,3,3,89,
          91,3,3,3,1,1,1,1,1,3,3,89,
          91,3,3,3,1,1,34,1,1,3,3,89,
          91,3,3,3,1,1,34,1,1,3,3,89,
          91,3,3,3,1,1,34,1,1,3,3,89,
          91,3,3,3,1,1,34,1,1,3,3,89,
          92,82,82,82,82,83,34,81,82,82,82,93
          });

      start_ = { 6, 1, Map::Facing::S };

      break;

    case 5:
      populate({
          90,90,90,90,90,91,13,97,98,98,98,85,
          90,90,90,90,90,91,33,1,3,3,1,89,
          90,90,90,90,90,91,33,1,1,3,3,89,
          98,98,98,98,98,99,33,1,1,1,1,89,
          87,87,87,87,87,87,87,88,34,1,1,89,
          95,95,95,95,95,95,95,96,34,1,1,89,
          103,103,103,103,103,103,103,104,34,1,1,89,
          83,1,1,1,1,1,1,1,1,1,1,97,
          91,86,87,87,87,88,1,12,1,1,1,16,
          91,94,95,95,95,96,34,1,1,3,3,81,
          91,94,95,95,95,96,34,1,1,3,3,89,
          91,94,95,95,95,96,34,1,1,1,1,89,
          91,102,103,103,103,104,1,10,1,1,1,89,
          92,82,82,82,82,83,1,81,82,82,82,93
          });

      start_ = { 6, 1, Map::Facing::S };
      pistons_.emplace_back(7, 8, Map::Facing::N, 4);
      pistons_.emplace_back(7, 12, Map::Facing::W, 4, 2);

      break;

    case 6:
      populate({
          84,98,98,98,98,99,13,97,98,98,98,85,
          91,1,3,3,1,1,1,1,1,1,1,89,
          91,86,87,87,87,88,1,86,87,88,1,89,
          91,94,95,95,95,96,1,94,95,96,1,89,
          91,94,95,95,95,96,1,94,95,96,1,89,
          91,94,95,95,95,96,3,94,95,96,1,89,
          99,102,103,103,103,104,1,102,103,104,1,89,
          1,1,1,1,1,1,1,1,1,3,1,97,
          83,1,86,87,87,87,87,87,87,88,1,16,
          91,3,94,95,95,95,95,95,95,96,1,81,
          91,3,94,95,95,95,95,95,95,96,1,89,
          91,1,102,103,103,103,103,103,103,104,1,89,
          91,1,1,1,1,1,1,1,3,3,3,89,
          92,82,82,82,82,83,14,81,82,82,82,93
          });

      start_ = { 6, 1, Map::Facing::S };

      break;

    case 7:
      populate({
          90,90,90,90,90,90,84,98,98,98,98,85,
          90,90,90,90,90,90,91,1,1,11,33,89,
          90,90,90,90,90,90,91,9,3,3,33,89,
          90,90,90,90,90,90,91,1,9,3,33,89,
          90,90,90,90,90,90,92,82,82,83,33,89,
          84,98,98,98,98,98,98,98,98,99,1,89,
          99,1,3,1,1,1,1,1,3,1,1,97,
          1,1,3,1,1,1,1,3,1,1,1,16,
          83,1,3,1,1,1,1,1,3,1,1,81,
          92,82,82,82,82,82,82,82,82,82,82,93,
          90,90,90,90,90,90,90,90,90,90,90,90,
          90,90,90,90,90,90,90,90,90,90,90,90,
          90,90,90,90,90,90,90,90,90,90,90,90,
          90,90,90,90,90,90,90,90,90,90,90,90
          });

      start_ = { 10, 7, Map::Facing::W };
      pistons_.emplace_back(9, 1, Map::Facing::S, 4, 2);
      pistons_.emplace_back(8, 3, Map::Facing::E, 4, 1);
      pistons_.emplace_back(7, 2, Map::Facing::E, 4, 3);

      break;

    case 8:
      populate({
          84,98,98,98,98,98,98,98,98,98,98,85,
          91,86,87,87,87,87,87,87,87,87,88,89,
          91,94,81,82,83,95,95,81,82,83,96,89,
          91,94,89,90,91,95,95,89,90,91,96,89,
          91,94,97,98,99,95,95,97,98,99,96,89,
          91,102,103,103,103,103,103,103,103,103,104,89,
          99,11,11,11,11,11,11,11,11,11,2,97,
          1,1,1,1,1,1,1,1,1,1,1,16,
          83,86,87,87,87,87,87,87,87,87,88,81,
          91,94,81,82,83,95,95,81,82,83,96,89,
          91,94,89,90,91,95,95,89,90,91,96,89,
          91,94,97,98,99,95,95,97,98,99,96,89,
          91,102,103,103,103,103,103,103,103,103,104,89,
          92,82,82,82,82,82,82,82,82,82,82,93
          });

      start_ = { 10, 7, Map::Facing::W };

      pistons_.emplace_back(1, 6, Map::Facing::S, 5, 3);
      pistons_.emplace_back(2, 6, Map::Facing::S, 5, 4);
      pistons_.emplace_back(3, 6, Map::Facing::S, 5, 3);
      pistons_.emplace_back(4, 6, Map::Facing::S, 5, 3);
      pistons_.emplace_back(5, 6, Map::Facing::S, 5, 2);
      pistons_.emplace_back(6, 6, Map::Facing::S, 5, 2);
      pistons_.emplace_back(7, 6, Map::Facing::S, 5, 1);
      pistons_.emplace_back(8, 6, Map::Facing::S, 5, 1);
      pistons_.emplace_back(9, 6, Map::Facing::S, 5, 3);

      break;

    case 9:
      populate({
          84,98,98,98,98,98,98,98,98,98,98,85,
          91,33,25,25,25,17,17,17,86,87,88,89,
          91,33,41,17,33,41,17,17,94,95,96,89,
          91,33,41,25,33,41,41,17,102,103,104,89,
          91,33,41,17,33,41,41,41,25,41,41,89,
          91,33,41,25,33,41,41,17,41,41,41,89,
          91,33,41,25,25,25,41,33,41,33,33,97,
          91,33,33,33,17,17,41,33,25,25,25,16,
          91,33,33,33,17,33,25,25,86,87,88,81,
          91,33,33,33,17,25,41,25,94,95,96,89,
          91,86,87,88,25,25,25,25,94,95,96,89,
          91,94,95,96,17,17,17,17,94,95,96,89,
          91,102,103,104,25,25,25,25,102,103,104,89,
          92,82,82,82,83,1,81,82,82,82,82,93
          });

      start_ = { 10, 7, Map::Facing::W };

      break;

    case 10:
      populate({
          84,98,98,98,99,13,97,98,98,98,85,90,
          91,1,1,1,2,1,2,1,1,1,89,90,
          91,1,2,1,2,1,2,1,2,1,89,90,
          91,1,3,1,1,3,1,3,1,1,97,85,
          92,83,1,2,2,1,2,1,2,2,2,89,
          90,91,1,1,1,1,2,1,1,1,1,89,
          84,99,2,2,2,2,2,1,2,2,1,89,
          91,1,1,1,1,1,1,3,1,1,1,89,
          91,1,81,82,83,1,1,81,82,83,1,89,
          91,3,89,90,91,3,1,89,90,91,1,89,
          91,1,89,90,91,1,2,89,90,91,1,89,
          91,1,97,98,99,1,1,97,98,99,1,89,
          91,1,1,1,1,1,1,3,1,3,1,89,
          92,82,82,82,83,1,81,82,82,82,82,93
          });

      start_ = { 5, 1, Map::Facing::S };

      break;
  }
}

void Level::update(unsigned int elapsed) {
  map_.update(elapsed);

  for (auto& p : pistons_) {
    p.update(elapsed);
  }

  for (auto& c : crates_) {
    c.update(elapsed);
  }
}

void Level::draw(Graphics& graphics) const {
  map_.draw(graphics);

  for (const auto& p : pistons_) {
    p.draw(graphics);
  }

  for (const auto& c : crates_) {
    c.draw(graphics);
  }
}

std::vector<Level::Push> Level::step_pistons() {
  std::vector<Push> pushes;

  for (auto& p : pistons_) {
    if (p.step()) {
      const auto from = p.push_from();
      const auto to = p.push_to();
      pushes.emplace_back(from, to);
    }
  }

  return pushes;
}

bool Level::oob(int x, int y) const {
  if (x < 0) return true;
  if (x >= map_.width()) return true;
  if (y < 0) return true;
  if (y >= map_.height()) return true;

  return false;
}

void Level::populate(std::vector<int> tiles) {
  int x = 0, y = 0;

  for (auto t : tiles) {
    map_.set_tile(x, y, Map::tile_from_sprite(t));

    if (t == 3) crates_.emplace_back(x * 16, y * 16);

    if (++x >= map_.width()) {
      x = 0;
      ++y;
    }
    if (y >= map_.height()) return;
  }
}

Map::Tile Level::tile(int x, int y) const {
  return map_.tile(x, y);
}

Level::Start Level::start() const {
  return start_;
}

bool Level::open(int px, int py) const {
  const int mx = px / 16;
  const int my = py / 16;

  Map::Tile tile = map_.tile(mx, my);
  if (tile.solid()) return false;

  for (const auto& c : crates_) {
    if (c.map_x() == mx && c.map_y() == my) return false;
  }

  return true;
}

bool Level::push(int px, int py, int tx, int ty) {
  const int mx = px / 16;
  const int my = py / 16;

  if (!open(tx, ty)) return false;

  for (auto& c : crates_) {
    if (c.map_x() == mx && c.map_y() == my) {
      c.push(kPushSpeed, tx / 16, ty / 16);
      return true;
    }
  }

  return false;
}
